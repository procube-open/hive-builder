---
- debug:
    var: "hostvars[item].ansible_facts.ipify_public_ip"
  loop: "{{ groups['servers'] | intersect(groups[hive_stage]) }}"
  register: debug_output
- name: write hosts
  blockinfile:
    path: "{{ hive_context_dir }}/mother-repository/hosts"
    marker: "# {mark} ANSIBLE MANAGED BLOCK extra_hosts {{ item }}"
    block: |
      {{ hostvars[item].ansible_facts.ipify_public_ip + ' ' + item}}
  loop: "{{ debug_output.results | map(attribute='item') | list }}"
  register: result
# - name: write hosts
#   blockinfile:
#     path: "/etc/hosts"
#     marker: "# {mark} ANSIBLE MANAGED BLOCK extra_hosts {{ item }}"
#     block: |
#       {{ hostvars[item].ansible_facts.ipify_public_ip + ' ' + item}}
#   loop: "{{ debug_output.results | map(attribute='item') | list }}"
- name: restart mother repository
  community.docker.docker_compose_v2:
    project_src: "{{ hive_context_dir }}"
    state: restarted
  become: true
  when: result is changed